---
import { getCollection } from 'astro:content';
import Section from '../Section.astro';
import type { BgVariant } from '../../utils/bgHelper';

interface Props {
  title?: string;
  subtitle?: string;
  agencies?: string[];
  expertises?: string[];
  sectors?: string[];
  selection?: string[];
  ctaLabel?: string;
  ctaLink?: string;
  bgVariant?: BgVariant;
}

const {
  title,
  subtitle,
  agencies = [],
  expertises = [],
  sectors = [],
  selection = [],
  ctaLabel,
  ctaLink,
  bgVariant,
} = Astro.props;

const allCommercials = await getCollection('commercials');

const agencyLabels: Record<string, string> = {
  lille: 'Lille',
  paris: 'Paris',
  lyon: 'Lyon',
  toulouse: 'Toulouse',
  barcelone: 'Barcelone',
  montreal: 'Montréal',
};

const hasAgencyFilter = agencies.length > 0;
const hasExpertiseFilter = expertises.length > 0;
const hasSectorFilter = sectors.length > 0;

const normalizedSelection = selection.map((item) => item.replace(/\.md$/, '').replace(/\.json$/, ''));

const filteredCommercials = allCommercials
  .filter((entry) => {
    const slug = entry.id.replace(/\.md$/, '').replace(/\.json$/, '');
    if (normalizedSelection.length > 0 && !normalizedSelection.includes(slug)) {
      return false;
    }
    if (hasAgencyFilter && !entry.data.agencies?.some((agency) => agencies.includes(agency))) {
      return false;
    }
    if (hasExpertiseFilter && !entry.data.expertises?.some((expertise) => expertises.includes(expertise))) {
      return false;
    }
    if (hasSectorFilter && !entry.data.sectors?.some((sector) => sectors.includes(sector))) {
      return false;
    }
    return true;
  })
  .map((entry) => ({
    ...entry.data,
    slug: entry.id.replace(/\.md$/, '').replace(/\.json$/, ''),
  }));

const hasCommercials = filteredCommercials.length > 0;
---
<Section variant={bgVariant || 'surface-2'}>
  <div class="space-y-10">
    <div class="max-w-3xl">
      {title && <h2 class="text-3xl md:text-4xl font-bold text-text">{title}</h2>}
      {subtitle && <p class="text-lg text-muted mt-4">{subtitle}</p>}
    </div>

    {hasCommercials ? (
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        {filteredCommercials.map((commercial) => (
          <article class="rounded-3xl border border-border bg-surface p-6 flex flex-col gap-4 shadow-sm">
            <div class="flex items-center gap-4">
              <img
                src={commercial.photo}
                alt={`${commercial.firstName} ${commercial.lastName}`}
                class="h-16 w-16 rounded-full object-cover border border-border"
                loading="lazy"
              />
              <div>
                <p class="text-lg font-semibold text-text">{commercial.firstName} {commercial.lastName}</p>
                <p class="text-sm text-muted">{commercial.role}</p>
              </div>
            </div>

            <div class="text-sm text-muted space-y-1">
              {commercial.agencies && (
                <p>{commercial.agencies.map((agency) => agencyLabels[agency] ?? agency).join(', ')}</p>
              )}
              {commercial.expertises && <p>Expertises : {commercial.expertises.join(', ')}</p>}
              {commercial.sectors && <p>Secteurs : {commercial.sectors.join(', ')}</p>}
            </div>

            <div class="text-sm space-y-2">
              <a
                href={`mailto:${commercial.email}`}
                class="block font-medium text-text hover:text-primary transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                aria-label={`Envoyer un email à ${commercial.firstName} ${commercial.lastName}`}
              >
                {commercial.email}
              </a>
              <a
                href={`tel:${commercial.phone.replace(/[\\s().-]/g, '')}`}
                class="block font-medium text-text hover:text-primary transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
                aria-label={`Appeler ${commercial.firstName} ${commercial.lastName}`}
              >
                {commercial.phone}
              </a>
            </div>

            {commercial.bio && <p class="text-sm text-muted">{commercial.bio}</p>}

            {commercial.linkedin && (
              <a
                href={commercial.linkedin}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm font-semibold text-primary hover:text-primary/80 transition-colors"
              >
                LinkedIn →
              </a>
            )}
          </article>
        ))}
      </div>
    ) : (
      <p class="text-sm text-muted">Les contacts commerciaux seront disponibles prochainement.</p>
    )}

    {ctaLabel && ctaLink && (
      <div>
        <a href={ctaLink} class="btn btn-primary inline-flex w-fit">
          {ctaLabel}
        </a>
      </div>
    )}
  </div>
</Section>
