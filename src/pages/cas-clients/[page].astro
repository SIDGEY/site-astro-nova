---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths({ paginate }) {
  const cases = await getCollection('cases');
  const sortedCases = [...cases].sort((a, b) => {
    const dateA = new Date(a.data.date).getTime();
    const dateB = new Date(b.data.date).getTime();
    return dateB - dateA;
  });
  
  // Extraire tous les secteurs et expertises pour les filtres
  const allSectors = [...new Set(cases.map(c => c.data.sector))].sort();
  // On récupère les tags de la stack qui ressemblent à des expertises
  const allTags = [...new Set(cases.flatMap(c => {
    return c.data.stack.map(s => typeof s === 'string' ? s : s.name);
  }))].sort();

  return paginate(sortedCases, { 
    pageSize: 9,
    props: { allSectors, allTags }
  });
}

const { page, allSectors, allTags } = Astro.props;
const cases = page.data;

const breadcrumbs = [
  { name: 'Accueil', item: 'https://atecna-2026.fr/' },
  { name: 'Cas clients', item: 'https://atecna-2026.fr/cas-clients' }
];

// On définit les filtres principaux (Top tags)
const topTags = [
  "Stratégie", 
  "Intelligence Artificielle", 
  "IA", 
  "Design UX/UI", 
  "Développement technique", 
  "Développement Mobile",
  "data",
  "Conseil digital"
].filter(tag => allTags.includes(tag));

---

<BaseLayout 
  title={`Cas Clients - Page ${page.currentPage} | Impact & Performance Digitale`}
  description="Découvrez comment Atecna accompagne les entreprises mid-market dans leur transformation via l'IA, la data et le produit."
  breadcrumbs={breadcrumbs}
>
  <div class="container-custom py-16 md:py-24">
    <header class="mb-20">
      <h1 class="text-5xl md:text-7xl font-bold mb-8 text-text leading-tight tracking-tight">
        Impact <span class="text-primary">concret.</span>
      </h1>
      <p class="text-xl md:text-2xl text-muted max-w-3xl leading-relaxed font-medium">
        Nous transformons les enjeux complexes en succès mesurables par la donnée, l'intelligence artificielle et l'excellence produit.
      </p>
    </header>

    <!-- Filtres (Interactifs via JS) -->
    <div class="space-y-6 mb-16 border-b border-border pb-8">
      <div class="flex flex-wrap gap-3">
        <button 
          data-filter="all"
          class="filter-btn px-6 py-2 rounded-full bg-primary text-primary-contrast font-bold text-sm transition-all"
        >
          Tous les cas
        </button>
        {topTags.map(tag => (
          <button 
            data-filter-tag={tag}
            class="filter-btn px-6 py-2 rounded-full bg-surface border border-border text-text hover:border-primary transition-all font-bold text-sm"
          >
            {tag}
          </button>
        ))}
      </div>
      
      <div class="flex flex-wrap gap-2">
        <span class="text-xs uppercase tracking-widest text-muted font-bold self-center mr-2">Secteurs :</span>
        {allSectors.map(sector => (
          <button 
            data-filter-sector={sector}
            class="filter-btn px-4 py-1.5 rounded-full bg-surface-2 border border-transparent text-muted hover:text-primary hover:border-primary transition-all font-bold text-xs"
          >
            {sector}
          </button>
        ))}
      </div>
    </div>
    
    <div id="cases-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-10">
      {cases.map(entry => (
        <article 
          class="case-card group transition-all duration-300" 
          data-tags={JSON.stringify(entry.data.stack.map(s => typeof s === 'string' ? s : s.name))}
          data-sector={entry.data.sector}
        >
          <a href={`/cas/${entry.slug}`} class="block space-y-6">
            <div class="aspect-video overflow-hidden rounded-[32px] bg-surface-2 border border-border group-hover:border-primary/30 transition-all duration-500 shadow-sm group-hover:shadow-xl flex items-center justify-center relative">
               <div class="absolute inset-0 bg-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
               {entry.data.featured && (
                 <div class="absolute top-4 right-4 badge bg-primary text-white shadow-lg text-[10px]">⭐ Mis en avant</div>
               )}
               {entry.data.coverImage ? (
                 <img src={entry.data.coverImage} alt={entry.data.clientName} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
               ) : (
                 <span class="text-2xl font-bold text-text/10 group-hover:text-primary/20 group-hover:scale-105 transition-all duration-700 uppercase tracking-tighter text-center px-6">
                   {entry.data.clientName}
                 </span>
               )}
            </div>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <div class="badge text-[10px]">
                  {entry.data.sector}
                </div>
                <span class="text-[10px] text-muted font-bold uppercase tracking-widest">
                  {new Date(entry.data.date).getFullYear()}
                </span>
              </div>
              <h2 class="text-xl font-bold text-text group-hover:text-primary transition-colors leading-tight line-clamp-2 min-h-[3rem]">
                {entry.data.summary}
              </h2>
              
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-border/50">
                {entry.data.results.slice(0, 2).map(result => (
                  <div class="flex flex-col">
                    <span class="text-primary font-bold text-xl tracking-tight">{result.value}</span>
                    <span class="text-muted text-[9px] uppercase font-bold tracking-[0.1em] line-clamp-1">{result.label}</span>
                  </div>
                ))}
              </div>
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- Pagination -->
    {page.lastPage > 1 && (
      <nav class="mt-20 flex justify-center items-center gap-4" aria-label="Pagination">
        {page.url.prev ? (
          <a href={page.url.prev} class="btn btn-outline btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m15 18-6-6 6-6"/></svg>
            Précédent
          </a>
        ) : (
          <span class="btn btn-outline btn-sm opacity-30 cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m15 18-6-6 6-6"/></svg>
            Précédent
          </span>
        )}
        
        <div class="text-sm font-bold text-muted">
          Page <span class="text-text">{page.currentPage}</span> sur {page.lastPage}
        </div>

        {page.url.next ? (
          <a href={page.url.next} class="btn btn-outline btn-sm">
            Suivant
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
        ) : (
          <span class="btn btn-outline btn-sm opacity-30 cursor-not-allowed">
            Suivant
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="m9 18 6-6-6-6"/></svg>
          </span>
        )}
      </nav>
    )}
  </div>

  <!-- Section CTA -->
  <section class="py-24 bg-surface-2/30">
    <div class="container-custom text-center">
      <h2 class="text-4xl font-bold mb-8">Un enjeu similaire dans votre organisation ?</h2>
      <p class="text-xl text-muted mb-12 max-w-2xl mx-auto">Nos experts vous accompagnent de la stratégie à l'exécution pour générer de la valeur durable.</p>
      <a href="/parler-ia" class="btn btn-primary btn-lg">Parler à un expert</a>
    </div>
  </section>
</BaseLayout>

<script>
  // Logique de filtrage côté client complète
  const filterButtons = document.querySelectorAll('.filter-btn');
  const caseCards = document.querySelectorAll('.case-card');
  const casesGrid = document.getElementById('cases-grid');

  // On stocke l'état du filtre
  let currentTag = 'all';
  let currentSector = 'all';

  function updateFilters() {
    let visibleCount = 0;
    caseCards.forEach(card => {
      const cardTags = JSON.parse(card.getAttribute('data-tags') || '[]');
      const cardSector = card.getAttribute('data-sector');
      
      const tagMatch = currentTag === 'all' || cardTags.includes(currentTag);
      const sectorMatch = currentSector === 'all' || cardSector === currentSector;

      if (tagMatch && sectorMatch) {
        (card as HTMLElement).classList.remove('hidden');
        (card as HTMLElement).classList.add('block');
        setTimeout(() => {
          (card as HTMLElement).style.opacity = '1';
          (card as HTMLElement).style.transform = 'translateY(0)';
        }, 10);
        visibleCount++;
      } else {
        (card as HTMLElement).style.opacity = '0';
        (card as HTMLElement).style.transform = 'translateY(20px)';
        setTimeout(() => {
          (card as HTMLElement).classList.remove('block');
          (card as HTMLElement).classList.add('hidden');
        }, 300);
      }
    });

    // Gérer le cas "aucun résultat"
    const noResult = document.getElementById('no-results');
    if (visibleCount === 0) {
      if (!noResult && casesGrid) {
        const div = document.createElement('div');
        div.id = 'no-results';
        div.className = 'col-span-full py-20 text-center';
        div.innerHTML = `
          <p class="text-2xl text-muted">Aucun cas client ne correspond à ces critères sur cette page.</p>
          <button class="mt-4 text-primary font-bold hover:underline" id="reset-filters">Réinitialiser les filtres</button>
        `;
        casesGrid.appendChild(div);
        document.getElementById('reset-filters')?.addEventListener('click', () => {
           const allBtn = document.querySelector('[data-filter="all"]') as HTMLButtonElement;
           allBtn?.click();
        });
      }
    } else {
      noResult?.remove();
    }
  }

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-filter-tag');
      const sector = btn.getAttribute('data-filter-sector');
      const isAll = btn.getAttribute('data-filter') === 'all';

      if (isAll) {
        currentTag = 'all';
        currentSector = 'all';
        // Reset button styles
        filterButtons.forEach(b => {
          b.classList.remove('bg-primary', 'text-primary-contrast');
          b.classList.add('bg-surface', 'text-text');
        });
        btn.classList.add('bg-primary', 'text-primary-contrast');
        btn.classList.remove('bg-surface', 'text-text');
      } else if (tag) {
        currentTag = tag;
        // Reset only tag buttons
        document.querySelectorAll('[data-filter-tag]').forEach(b => {
          b.classList.remove('bg-primary', 'text-primary-contrast');
          b.classList.add('bg-surface', 'text-text');
        });
        document.querySelector('[data-filter="all"]')?.classList.remove('bg-primary', 'text-primary-contrast');
        document.querySelector('[data-filter="all"]')?.classList.add('bg-surface', 'text-text');
        btn.classList.add('bg-primary', 'text-primary-contrast');
        btn.classList.remove('bg-surface', 'text-text');
      } else if (sector) {
        currentSector = sector;
        // Reset only sector buttons
        document.querySelectorAll('[data-filter-sector]').forEach(b => {
          b.classList.remove('bg-primary', 'text-primary-contrast');
          b.classList.add('bg-surface-2');
        });
        document.querySelector('[data-filter="all"]')?.classList.remove('bg-primary', 'text-primary-contrast');
        document.querySelector('[data-filter="all"]')?.classList.add('bg-surface', 'text-text');
        btn.classList.add('bg-primary', 'text-primary-contrast');
        btn.classList.remove('bg-surface-2');
      }

      updateFilters();
    });
  });
</script>
